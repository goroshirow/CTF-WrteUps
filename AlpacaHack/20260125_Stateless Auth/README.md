# Stateless Auth

## / Overview

Flask の設定ミスによる JWT 秘密鍵漏洩を利用した署名偽造。

## / Writeup

今回の目標は `admin` としてログインすることです。しかしログインフォームから直接 `admin` を指定すると、弾かれる仕組みになっています。

ログインフォーム以外から `admin` としてログインするには、ログイン後の JWT 認証情報を偽造する必要があります。

### JWTとは

JWT はサーバがトークンを発行することで、クライアント側でセッション情報を管理する仕組みです。

> 参考記事
>
> https://qiita.com/asagohan2301/items/cef8bcb969fef9064a5c


トークンは `<Base64URL(ヘッダー)>.<Base64URL(ペイロード)>.<Base64URL(署名)>` のように構成されています。


署名アルゴリズムは `HMAC-SHA256` であり、秘密鍵なしでの偽造は不可能と思われます。

### Flaskのデフォルト公開ディレクトリ

Flask ではデフォルトで `static` フォルダ以下のファイルは外部に公開されます。つまり、ブラウザなどから `http://34.170.146.252:28215/static/jwt_secret.txt` にアクセスするだけで、誰でも秘密鍵を入手できます。

### トークンの偽造

秘密鍵が分かっているなら、次の手順でトークンを偽造できます。(Cookieの書き換えにはBurp Suiteを使いました)

* `admin`以外のユーザーネームでログインする。
* Cookieからトークン情報をコピーする。
* 元のトークンのbase64ペイロード部をデコードする。
* `sub`のバリューを`admin`に書き換えたものを新たなペイロードとする。
* `app.py`と同じ仕組みでトークンを生成する。(秘密鍵は入手したものに置き換える)
* ページの更新でCookieを再送するときに新しいトークンをセットする。

これでフラグを入手できます。
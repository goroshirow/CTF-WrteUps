# RGB

## / Overview

### 与えられた情報

* **公開鍵**: 137bitの素数 $`p, q`$ の積 $`N = p \cdot q`$  
* **暗号文**: $`C\_1, C\_2, \dots, C\_{13}`$（計13個）  
* **暗号化プロセス**: 
  * 指数 $`e`$ は以下の線形合同式 (LCG) によって逐次更新される。  
    $`e_{i} \equiv 3e_{i-1} + 1337 \pmod N`$  
  * 各暗号文は $`C_i \equiv m^{e_i} \pmod N`$ として計算される。
  * $`e, p, q`$は非公開

### 目的

これらの情報から平文 $`m`$ を復元する。

## / Writeup

### Step 1: 素因数分解

$`p, q`$ がそれぞれ137bitであり、素因数分解できそう。 

`sympy`で素因数分解を試みたが、時間がかかりすぎる。

調べてみると[FactorDB](https://factordb.com/)というデータベースがあって、それをを利用すると素因数が得られた。

```python  
# 実際に得られた素数  
p = 87569276771316598432602743640004330672211  
q = 106064726489863337434900206767547070156877
```
$`p, q`$が分かるなら、$`\phi(N)=(p-1)(q-1)`$を求めることができる。

これにより、なにか既知の数$`X`$を用いた$`m^X`$が得られるなら、

$`d = X^{-1} \pmod{\phi(N)}`$

を用いて$`(m^X)^{d} \equiv m \pmod N`$を計算できるようになった。

### Step 2: 線形合同式の関係

$`e`$が不明なため、単一の $`C_i`$ から復号することはできないと思った。そこで、連続する2つの暗号文 $`C_1, C_2`$ の関係性を利用する。  
指数の更新式は以下の通りである。

$`e_2 \equiv 3e_1 + 1337 \pmod N`$  

この合同式を、等式として書き直すと以下のようになる。

$`e_2 = 3e_1 + 1337 - k \cdot N`$  

$`k`$ は、$`e_2`$を$`N`$で割ったときの商と言える。  

$`0 \le e_1 < N`$ であるため、$`0 \le 3e_1 < 3N`$ となる。これに定数 $`1337`$ を加えても $`3N`$ を少し超える程度であるため、$`k \in \{0, 1, 2, 3\}`$ のいずれかとなる。

### Step 3: 線形合同式から$`X`$を作る

Step 2の等式を、暗号文 $`C_2 \equiv m^{e_2} \pmod N`$ の指数部分に代入する。  

$`
\begin{aligned} 
  C_2 &\equiv m^{e_2} \\ 
  &\equiv m^{3e_1 + 1337 - k N} \\ 
  &\equiv (m^{e_1})^3 \cdot m^{1337 - k N} \\ 
  &\equiv C_1^3 \cdot m^{1337 - k N} \pmod N 
\end{aligned}
`$  

これを $`m`$ について整理する。両辺に $`C_1^{-3}`$ を掛けると
$`m^{1337 - k N} \equiv C_2 \cdot C_1^{-3} \pmod N`$  

ここで、右辺 $`C_2 \cdot C_1^{-3}`$ は全て既知の値である。 

左辺の指数 $`X_k = 1337 - k N`$ は $`k`$ が決まれば確定する。

### Step 4: 復号

あとは $`k`$ を $`0`$ から $`3`$ まで総当たりし、復号を行う。

1. 指数 $`X_k = 1337 - k N`$ を計算する。  
2. 復号のための指数 $`d_k \equiv X_k^{-1} \pmod{\phi(N)}`$ を計算する。  
(逆元が存在しない場合はValueErrorになるのでスキップ)
3. 候補平文 $`m' \equiv (C_2 \cdot C_1^{-3})^{d_k} \pmod N`$ を計算し、フラグの形式か確認する。

これでフラグが得られる。

